<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jam Beban Calculator (Pengajaran)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; line-height: 1.35; }
    h1 { margin: 0 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin-bottom: 16px; }
    .grid { display: grid; grid-template-columns: repeat(9, minmax(120px, 1fr)); gap: 10px; }
    label { font-size: 12px; color: #333; display: block; margin-bottom: 4px; }
    input, select { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 10px; }
    button { padding: 10px 12px; border: 1px solid #111; border-radius: 12px; background: #111; color: #fff; cursor: pointer; }
    button.secondary { background: #fff; color: #111; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 10px 8px; text-align: left; }
    th { font-size: 12px; color: #444; background: #fafafa; position: sticky; top: 0; }
    td.num { text-align: right; font-variant-numeric: tabular-nums; }
    .muted { color: #666; font-size: 12px; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; background: #f2f2f2; font-size: 12px; }
    .danger { color: #b00020; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    @media (max-width: 900px) { .grid { grid-template-columns: repeat(2, minmax(120px, 1fr)); } }
  </style>
  <!-- KaTeX for rendering math formulas -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.getElementById('formulaBlock'),{delimiters:[{left:'$$',right:'$$',display:true},{left:'\\(',right:'\\)',display:false}]});"></script>
</head>
<body>
  <h1>Jam Beban Calculator (Pengajaran)</h1>
  <p class="muted">
    Model:
    <span class="pill">JamPelajar = MAX(0, BilPelajar - T) x 0.033 [T=30, Makmal Btech: T=15]</span>
    <span class="pill">Nilai Beban = (Jam Pertemuan x Jam Beban x Bil. Minggu) + (JamPelajar x Bil. Minggu)</span>
  </p>

  <div class="card">
    <h2 style="margin:0 0 10px;">Register Subject</h2>

    <div class="grid" style="grid-template-columns: repeat(3, minmax(120px, 1fr));">
      <div>
        <label for="newSubject">Subject Code</label>
        <input id="newSubject" type="text" placeholder="e.g., DSC101" />
      </div>
      <div style="display: flex; align-items: flex-end;">
        <button id="addSubjectBtn">Add Subject</button>
      </div>
    </div>

    <div style="margin-top: 12px;">
      <p class="muted" style="margin:0 0 8px;">Registered Subjects:</p>
      <div id="subjectList" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px;">Add Row</h2>

    <div class="grid">
      <div>
        <label for="subject">Subject</label>
        <select id="subject">
          <option value="">-- Select Subject --</option>
        </select>
      </div>

      <div>
        <label for="semester">Semester</label>
        <input id="semester" type="number" min="0" step="1" value="3" />
      </div>

      <div>
        <label for="kredit">Kredit</label>
        <input id="kredit" type="number" min="0" step="0.5" value="3" />
      </div>

      <div>
        <label for="jamMinggu">Jam Pertemuan (Mingguan)</label>
        <input id="jamMinggu" type="number" min="0" step="0.5" value="3" />
      </div>

      <div>
        <label for="peringkat">Peringkat</label>
        <select id="peringkat">
          <option value="1 - Prasiswazah">1 - Prasiswazah</option>
          <option value="2 - Pascasiswazah">2 - Pascasiswazah</option>
        </select>
      </div>

      <div>
        <label for="jenis">Jenis</label>
        <select id="jenis">
          <option value="1 - Kuliah">1 - Kuliah</option>
          <option value="2 - Makmal">2 - Makmal</option>
          <option value="3 - Makmal (Btech)">3 - Makmal (Btech)</option>
          <option value="4 - Tutorial">4 - Tutorial</option>
        </select>
      </div>

      <div>
        <label for="kumpulan">Kumpulan</label>
        <select id="kumpulan">
          <option value="1 - Kumpulan Pertama">1 - Kumpulan Pertama</option>
          <option value="2 - Kumpulan Ulangan">2 - Kumpulan Ulangan</option>
        </select>
      </div>

      <div>
        <label for="pelajar">Bilangan Pelajar</label>
        <input id="pelajar" type="number" min="0" step="1" value="30" />
      </div>

      <div>
        <label for="minggu">Bilangan Minggu</label>
        <input id="minggu" type="number" min="0" step="1" value="14" />
      </div>
    </div>

    <div class="row">
      <button id="addBtn">Add to Table</button>
      <button id="clearBtn" class="secondary">Clear Table</button>
      <button id="exportBtn" class="secondary">Save Data</button>
      <button id="importBtn" class="secondary">Import Data</button>
      <input id="importFile" type="file" accept=".json" style="display:none;" />
      <span id="preview" class="muted"></span>
    </div>

    <p class="muted" style="margin-top:10px;">
      Default rules:
      <span class="mono">Wajaran Beban Seminggu</span> = Jenis 1/2/3 -> Kumpulan Pertama: 3, Kumpulan Ulangan: 2; Jenis 4 -> 1.
    </p>
  </div>

  <div class="card">
    <div class="row" style="justify-content: space-between; align-items: flex-start;">
      <div>
        <h2 style="margin:0 0 10px;">Table</h2>
        <div style="display: flex; gap: 12px; align-items: center;">
          <div>
            <label for="maxTarget" style="display: block; font-size: 12px; color: #333; margin-bottom: 4px;">Max Target Jam Beban</label>
            <input id="maxTarget" type="number" min="0" step="0.5" value="60" style="width: 120px;" />
          </div>
          <div>
            <div id="progressInfo" class="muted" style="font-size: 13px; margin-top: 18px;"><strong id="percentage">0</strong>%</div>
          </div>
        </div>
      </div>
      <div class="muted">
        Total Jam Beban: <strong id="totalJam">0</strong>
      </div>
    </div>

    <div style="width: 100%; height: 24px; background: #e0e0e0; border-radius: 6px; overflow: hidden; margin-top: 10px;">
      <div id="progressBar" style="height: 100%; width: 0%; background: #4caf50; transition: width 0.3s ease, background-color 0.3s ease; display: flex; align-items: center; justify-content: center; font-size: 11px; color: white; font-weight: bold;"></div>
    </div>

    <!-- Mathematical formulas explaining the calculations -->
    <div id="formulaBlock" style="margin-top:12px;">
      $$\mathrm{Jam_{Pelajar}} = \max\left(0,\;\mathrm{BilPelajar}-T\right)\times 0.033$$
      
      $$\mathrm{Nilai\ Beban} = (\mathrm{Jam\ Pertemuan}\times\mathrm{Jam\ Beban}\times\mathrm{Bil.\ Minggu}) + (\mathrm{Jam_{Pelajar}}\times\mathrm{Bil.\ Minggu})$$
    </div>

    <div style="overflow:auto; max-height: 55vh; margin-top: 10px;">
      <table id="tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>Subject</th>
            <th class="num">Kredit</th>
            <th class="num">Semester</th>
            <th class="num">Jam Pertemuan (Mingguan)</th>
            <th>Peringkat</th>
            <th>Jenis</th>
            <th>Kumpulan</th>
            <th class="num">Bilangan Pelajar</th>
            <th class="num">Bilangan Minggu</th>
            <th class="num">Jam Pelajar (&gt;30)</th>
            <th class="num">Wajaran Beban Seminggu</th>
            <th class="num">Jam Beban</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <p id="msg" class="muted" style="margin-top:10px;"></p>
  </div>

  <script>
    // --- Rules (match sheet behaviour seen in your screenshot) ---
    function parseJenisNumber(jenis) {
      // "3 - Makmal (Btech)" -> 3
      const m = String(jenis).match(/^(\d+)\s*-/);
      return m ? Number(m[1]) : NaN;
    }

    function includesCI(haystack, needle) {
      return String(haystack).toLowerCase().includes(String(needle).toLowerCase());
    }

    function getActivityConfig({ jenis, kumpulan }) {
      const j = String(jenis || "");
      const k = String(kumpulan || "");

      let baseCoeff = 0;
      let threshold = 30;

      if (includesCI(j, "tutorial") || j.trim().startsWith("4")) {
        baseCoeff = 1;
        threshold = 30;
        return { baseCoeff, threshold, activity: "tutorial" };
      }

      if (includesCI(j, "program teknologi") || includesCI(j, "teknologi")) {
        baseCoeff = 2;
        threshold = 15;
        return { baseCoeff, threshold, activity: "makmal_program_teknologi" };
      }

      if (includesCI(j, "makmal") || j.trim().startsWith("2") || j.trim().startsWith("3")) {
        baseCoeff = 2;
        threshold = 30;
        return { baseCoeff, threshold, activity: "makmal" };
      }

      if (includesCI(j, "kuliah") || j.trim().startsWith("1")) {
        if (includesCI(k, "pertama") || k.trim().startsWith("1")) {
          baseCoeff = 3;
        } else if (includesCI(k, "ulangan") || k.trim().startsWith("2")) {
          baseCoeff = 2;
        } else {
          baseCoeff = 3;
        }
        threshold = 30;
        return { baseCoeff, threshold, activity: "kuliah" };
      }

      return { baseCoeff, threshold, activity: "unknown" };
    }

    const EXTRA_RATE = 0.033;

    function calcJamPelajar(bilanganPelajar, threshold) {
      const E = Number(bilanganPelajar) || 0;
      const extraStudents = Math.max(0, E - threshold);
      return extraStudents * EXTRA_RATE;
    }

    function calcWajaranBebanSeminggu(jenis, kumpulan) {
      const { baseCoeff } = getActivityConfig({ jenis, kumpulan });
      return baseCoeff;
    }

    function round1(x) {
      // numeric rounding to 1 decimal (keep as number)
      return Math.round((Number(x) + Number.EPSILON) * 10) / 10;
    }

    function calcAll({ jamPertemuanMingguan, jenis, kumpulan, bilanganPelajar, bilanganMinggu }) {
      const A = Number(jamPertemuanMingguan) || 0;
      const F = Number(bilanganMinggu) || 0;
      const { baseCoeff, threshold } = getActivityConfig({ jenis, kumpulan });
      const H = baseCoeff;
      const G = calcJamPelajar(bilanganPelajar, threshold);
      const I = (A * H * F) + (G * F);

      return {
        jamPelajar: round1(G),            // display 1dp like excel screenshot
        wajaran: H,                       // 1.0 or 2.0
        jamBeban: round1(I),              // display 1dp
        // if you also want raw values:
        jamPelajar_raw: G,
        jamBeban_raw: I
      };
    }

    // --- UI ---
    const els = {
      newSubject: document.getElementById("newSubject"),
      addSubjectBtn: document.getElementById("addSubjectBtn"),
      subjectList: document.getElementById("subjectList"),
      subject: document.getElementById("subject"),
      semester: document.getElementById("semester"),
      kredit: document.getElementById("kredit"),
      jamMinggu: document.getElementById("jamMinggu"),
      peringkat: document.getElementById("peringkat"),
      jenis: document.getElementById("jenis"),
      kumpulan: document.getElementById("kumpulan"),
      pelajar: document.getElementById("pelajar"),
      minggu: document.getElementById("minggu"),
      addBtn: document.getElementById("addBtn"),
      clearBtn: document.getElementById("clearBtn"),
      tbody: document.getElementById("tbody"),
      totalJam: document.getElementById("totalJam"),
      maxTarget: document.getElementById("maxTarget"),
      percentage: document.getElementById("percentage"),
      progressBar: document.getElementById("progressBar"),
      preview: document.getElementById("preview"),
      msg: document.getElementById("msg"),
      exportBtn: document.getElementById("exportBtn"),
      importBtn: document.getElementById("importBtn"),
      importFile: document.getElementById("importFile"),
    };

    const subjects = [];
    const rows = [];

    // --- Progress Bar Update ---
    function updateProgressBar() {
      const total = parseFloat(els.totalJam.textContent) || 0;
      const maxTarget = parseFloat(els.maxTarget.value) || 100;
      const pct = Math.min(100, Math.round((total / maxTarget) * 100));
      els.percentage.textContent = pct;
      
      let bgColor = "#4caf50"; // green
      if (pct > 100) {
        bgColor = "#f44336"; // red (over)
      } else if (pct > 80) {
        bgColor = "#ff9800"; // orange (warning)
      }
      
      els.progressBar.style.width = pct + "%";
      els.progressBar.style.backgroundColor = bgColor;
      els.progressBar.textContent = pct > 5 ? pct + "%" : "";
    }

    // --- Subject Management ---
    function renderSubjects() {
      els.subjectList.innerHTML = subjects
        .map((s, idx) => `
          <span class="pill">
            ${s}
            <button class="secondary" style="padding: 2px 6px; font-size: 11px; margin-left: 4px;" data-del-subject="${idx}">x</button>
          </span>
        `)
        .join("");
      
      // Update subject dropdown
      const currentValue = els.subject.value;
      els.subject.innerHTML = `<option value="">-- Select Subject --</option>` + 
        subjects.map(s => `<option value="${s}">${s}</option>`).join("");
      els.subject.value = currentValue;
    }

    function addSubject() {
      const code = els.newSubject.value.trim();
      if (!code) {
        els.msg.innerHTML = `<span class="danger">Please enter a subject code.</span>`;
        return;
      }
      if (subjects.includes(code)) {
        els.msg.innerHTML = `<span class="danger">Subject already registered.</span>`;
        return;
      }
      subjects.push(code);
      els.newSubject.value = "";
      renderSubjects();
      els.msg.textContent = `Subject "${code}" registered!`;
      setTimeout(() => (els.msg.textContent = ""), 2000);
    }

    els.addSubjectBtn.addEventListener("click", addSubject);
    els.newSubject.addEventListener("keypress", (e) => {
      if (e.key === "Enter") addSubject();
    });

    document.getElementById("subjectList").addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-del-subject]");
      if (!btn) return;
      const idx = Number(btn.getAttribute("data-del-subject"));
      if (Number.isFinite(idx)) {
        const removed = subjects.splice(idx, 1);
        renderSubjects();
        els.msg.textContent = `Subject "${removed[0]}" removed.`;
        setTimeout(() => (els.msg.textContent = ""), 2000);
      }
    });

    // --- File Export/Import functions ---
    function exportData() {
      if (rows.length === 0) {
        els.msg.innerHTML = `<span class="danger">No data to export.</span>`;
        return;
      }
      const dataStr = JSON.stringify({ subjects, rows }, null, 2);
      const dataBlob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `bta-data-${new Date().toISOString().slice(0,10)}.json`;
      link.click();
      URL.revokeObjectURL(url);
      els.msg.textContent = "Data saved successfully!";
      setTimeout(() => updatePreview(), 2000);
    }

    function importData() {
      els.importFile.click();
    }

    els.importFile.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const imported = JSON.parse(event.target.result);
          if (imported.subjects && Array.isArray(imported.subjects)) {
            subjects.length = 0;
            subjects.push(...imported.subjects);
            renderSubjects();
          }
          if (imported.rows && Array.isArray(imported.rows)) {
            rows.length = 0;
            rows.push(...imported.rows);
          }
          render();
          els.msg.textContent = `Imported ${rows.length} row(s) and ${subjects.length} subject(s)!`;
          setTimeout(() => updatePreview(), 2000);
        } catch (err) {
          els.msg.innerHTML = `<span class="danger">Error importing: ${err.message}</span>`;
        }
      };
      reader.readAsText(file);
    });

    function readInputs() {
      const subject = els.subject.value.trim();
      const semester = Number(els.semester.value);
      const kredit = Number(els.kredit.value);
      const jamMinggu = Number(els.jamMinggu.value);
      const peringkat = els.peringkat.value;
      const jenis = els.jenis.value;
      const kumpulan = els.kumpulan.value;
      const pelajar = Number(els.pelajar.value);
      const minggu = Number(els.minggu.value);

      const problems = [];
      if (!Number.isFinite(semester) || semester < 0) problems.push("Semester");
      if (!Number.isFinite(kredit) || kredit < 0) problems.push("Kredit");
      if (!Number.isFinite(jamMinggu) || jamMinggu < 0) problems.push("Jam Pertemuan (Mingguan)");
      if (!Number.isFinite(pelajar) || pelajar < 0) problems.push("Bilangan Pelajar");
      if (!Number.isFinite(minggu) || minggu < 0) problems.push("Bilangan Minggu");

      return { subject, semester, kredit, jamMinggu, peringkat, jenis, kumpulan, pelajar, minggu, problems };
    }

    function render() {
      els.tbody.innerHTML = "";
      let total = 0;

      rows.forEach((r, idx) => {
        const calc = calcAll({
          jamPertemuanMingguan: r.jamMinggu,
          jenis: r.jenis,
          kumpulan: r.kumpulan,
          bilanganPelajar: r.pelajar,
          bilanganMinggu: r.minggu
        });
        const w = calc.wajaran;
        const jp = calc.jamPelajar;
        const jb = calc.jamBeban;
        total += jb;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${r.subject || "--"}</td>
          <td class="num">${r.kredit}</td>
          <td class="num">${r.semester ?? ""}</td>
          <td class="num">${r.jamMinggu}</td>
          <td>${r.peringkat ?? ""}</td>
          <td>${r.jenis}</td>
          <td>${r.kumpulan}</td>
          <td class="num">${r.pelajar}</td>
          <td class="num">${r.minggu}</td>
          <td class="num">${jp.toFixed(1)}</td>
          <td class="num">${w.toFixed(1)}</td>
          <td class="num"><strong>${jb.toFixed(1)}</strong></td>
          <td><button class="secondary" data-del="${idx}">Delete</button></td>
        `;
        els.tbody.appendChild(tr);
      });

      // total to 1 dp too
      els.totalJam.textContent = round1(total).toFixed(1);
      updateProgressBar();

      els.msg.textContent = rows.length
        ? "This matches the sheet pattern you showed (incl. Jam Pelajar >30 and 1-decimal Jam Beban)."
        : "No rows yet -- add one above.";
    }

    function updatePreview() {
      const { jamMinggu, jenis, pelajar, minggu, kumpulan, problems } = readInputs();
      if (problems.length) {
        els.preview.innerHTML = `<span class="danger">Check: ${problems.join(", ")}</span>`;
        return;
      }
      const calc = calcAll({
        jamPertemuanMingguan: jamMinggu,
        jenis,
        kumpulan,
        bilanganPelajar: pelajar,
        bilanganMinggu: minggu
      });
      els.preview.textContent = `Preview -> Wajaran Beban Seminggu: ${calc.wajaran.toFixed(1)}, Jam Pelajar(>30): ${calc.jamPelajar.toFixed(1)}, Jam Beban: ${calc.jamBeban.toFixed(1)}`;
    }

    els.addBtn.addEventListener("click", () => {
      const data = readInputs();
      if (data.problems.length) {
        els.msg.innerHTML = `<span class="danger">Please fix: ${data.problems.join(", ")}.</span>`;
        return;
      }
      rows.push({
        subject: data.subject,
        semester: data.semester,
        kredit: data.kredit,
        jamMinggu: data.jamMinggu,
        peringkat: data.peringkat,
        jenis: data.jenis,
        kumpulan: data.kumpulan,
        pelajar: data.pelajar,
        minggu: data.minggu,
      });
      render();
      updatePreview();
    });

    els.clearBtn.addEventListener("click", () => {
      rows.length = 0;
      render();
      updatePreview();
    });

    document.getElementById("tbl").addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-del]");
      if (!btn) return;
      const idx = Number(btn.getAttribute("data-del"));
      if (Number.isFinite(idx)) {
        rows.splice(idx, 1);
        render();
      }
    });

    els.exportBtn.addEventListener("click", exportData);
    els.importBtn.addEventListener("click", importData);
    els.maxTarget.addEventListener("input", updateProgressBar);
    els.maxTarget.addEventListener("change", updateProgressBar);

    ["subject","semester","kredit","jamMinggu","peringkat","jenis","kumpulan","pelajar","minggu"].forEach(id => {
      document.getElementById(id).addEventListener("input", updatePreview);
      document.getElementById(id).addEventListener("change", updatePreview);
    });

    updatePreview();
    render();
  </script>
</body>
</html>
